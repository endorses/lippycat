syntax = "proto3";

package lippycat.management;

option go_package = "github.com/endorses/lippycat/api/gen/management";

// ManagementService handles monitoring, configuration, and filter distribution
service ManagementService {
    // RegisterHunter is called when a hunter connects to a processor
    rpc RegisterHunter(HunterRegistration) returns (RegistrationResponse);

    // RegisterProcessor is called when a processor connects to forward to upstream
    rpc RegisterProcessor(ProcessorRegistration) returns (ProcessorRegistrationResponse);

    // Heartbeat maintains connection and reports hunter status
    rpc Heartbeat(stream HunterHeartbeat) returns (stream ProcessorHeartbeat);

    // GetFilters retrieves current filter configuration for a hunter
    rpc GetFilters(FilterRequest) returns (FilterResponse);

    // SubscribeFilters is a stream for real-time filter updates
    rpc SubscribeFilters(FilterRequest) returns (stream FilterUpdate);

    // GetHunterStatus retrieves status of connected hunters (for TUI)
    rpc GetHunterStatus(StatusRequest) returns (StatusResponse);

    // UpdateFilter adds or modifies a filter (processor only)
    rpc UpdateFilter(Filter) returns (FilterUpdateResult);

    // DeleteFilter removes a filter (processor only)
    rpc DeleteFilter(FilterDeleteRequest) returns (FilterUpdateResult);

    // ListAvailableHunters retrieves list of all hunters connected to processor (for TUI hunter selection)
    rpc ListAvailableHunters(ListHuntersRequest) returns (ListHuntersResponse);

    // GetTopology retrieves the complete downstream topology (processors and hunters)
    // Recursively queries downstream processors to build full hierarchy
    rpc GetTopology(TopologyRequest) returns (TopologyResponse);

    // SubscribeTopology subscribes to real-time topology changes
    // Returns a stream of topology updates when hunters/processors connect/disconnect
    // Replaces polling GetTopology() for real-time monitoring
    rpc SubscribeTopology(TopologySubscribeRequest) returns (stream TopologyUpdate);

    // UpdateFilterOnProcessor adds or modifies a filter on a specific processor
    // Used for multi-level management to target filters to specific processors in the hierarchy
    rpc UpdateFilterOnProcessor(ProcessorFilterRequest) returns (FilterUpdateResult);

    // DeleteFilterOnProcessor removes a filter from a specific processor
    // Used for multi-level management to remove filters from specific processors in the hierarchy
    rpc DeleteFilterOnProcessor(ProcessorFilterDeleteRequest) returns (FilterUpdateResult);

    // GetFiltersFromProcessor retrieves filters from a specific processor
    // Used for multi-level management to query filter state in the hierarchy
    rpc GetFiltersFromProcessor(ProcessorFilterQuery) returns (FilterResponse);

    // RequestAuthToken requests an authorization token for proxied operations
    // Used by TUI clients to get tokens for managing downstream processors
    // The token is signed by the processor and can be verified by downstream processors
    rpc RequestAuthToken(AuthTokenRequest) returns (AuthorizationToken);
}

// HunterRegistration sent when hunter first connects
message HunterRegistration {
    // Unique hunter identifier
    string hunter_id = 1;

    // Hunter hostname
    string hostname = 2;

    // Network interfaces being captured
    repeated string interfaces = 3;

    // Hunter version
    string version = 4;

    // Capture capabilities
    HunterCapabilities capabilities = 5;
}

// ProcessorRegistration sent when a processor connects to forward upstream
message ProcessorRegistration {
    // Processor identifier
    string processor_id = 1;

    // Processor listen address (for upstream to query back)
    string listen_address = 2;

    // Processor version
    string version = 3;

    // Chain of upstream processor IDs from root to this processor
    // Empty if this is a leaf processor connecting directly to root
    // Example: ["root", "intermediate1", "intermediate2"] means this processor
    // connects to intermediate2, which connects to intermediate1, which connects to root
    repeated string upstream_chain = 4;
}

// ProcessorRegistrationResponse from upstream after processor registration
message ProcessorRegistrationResponse {
    // Registration accepted
    bool accepted = 1;

    // Error message if rejected
    string error = 2;

    // Upstream processor ID (the processor that accepted this registration)
    // This allows the downstream processor to know its parent's ID for topology reporting
    string upstream_processor_id = 3;
}

// HunterCapabilities describes what a hunter can do
message HunterCapabilities {
    // Supported filter types
    repeated string filter_types = 1;

    // Maximum buffer size (bytes)
    uint64 max_buffer_size = 2;

    // Supports GPU acceleration
    bool gpu_acceleration = 3;

    // Supports AF_XDP
    bool af_xdp = 4;
}

// RegistrationResponse from processor after registration
message RegistrationResponse {
    // Registration accepted
    bool accepted = 1;

    // Error message if rejected
    string error = 2;

    // Assigned hunter ID (may differ from requested)
    string assigned_id = 3;

    // Initial filter configuration
    repeated Filter filters = 4;

    // Processor configuration
    ProcessorConfig config = 5;
}

// ProcessorConfig sent to hunter
message ProcessorConfig {
    // Batch size for packet transmission
    uint32 batch_size = 1;

    // Batch timeout (milliseconds)
    uint32 batch_timeout_ms = 2;

    // Reconnection interval (seconds)
    uint32 reconnect_interval_sec = 3;

    // Maximum reconnection attempts (0 = infinite)
    uint32 max_reconnect_attempts = 4;

    // Processor identifier
    string processor_id = 5;
}

// HunterHeartbeat sent periodically by hunter
message HunterHeartbeat {
    // Hunter identifier
    string hunter_id = 1;

    // Timestamp (Unix nanoseconds)
    int64 timestamp_ns = 2;

    // Current hunter status
    HunterStatus status = 3;

    // Statistics since last heartbeat
    HunterStats stats = 4;
}

// HunterStatus enum
enum HunterStatus {
    // Hunter is capturing and forwarding normally
    STATUS_HEALTHY = 0;

    // Hunter is capturing but buffer is filling up
    STATUS_WARNING = 1;

    // Hunter has errors or stopped capturing
    STATUS_ERROR = 2;

    // Hunter is shutting down
    STATUS_STOPPING = 3;
}

// HunterStats contains capture statistics
message HunterStats {
    // Packets captured
    uint64 packets_captured = 1;

    // Packets matched by filters
    uint64 packets_matched = 2;

    // Packets forwarded to processor
    uint64 packets_forwarded = 3;

    // Packets dropped
    uint64 packets_dropped = 4;

    // Current buffer usage (bytes)
    uint64 buffer_bytes = 5;

    // Active filters count
    uint32 active_filters = 6;

    // CPU usage percentage (0-100, -1 if unavailable)
    float cpu_percent = 7;

    // Process resident set size in bytes
    uint64 memory_rss_bytes = 8;

    // Memory limit in bytes (from cgroup, 0 if unavailable)
    uint64 memory_limit_bytes = 9;
}

// ProcessorHeartbeat response from processor
message ProcessorHeartbeat {
    // Timestamp (Unix nanoseconds)
    int64 timestamp_ns = 1;

    // Processor status
    ProcessorStatus status = 2;

    // Total hunters connected
    uint32 hunters_connected = 3;

    // Processor identifier
    string processor_id = 4;
}

// ProcessorStatus enum
enum ProcessorStatus {
    // Processor operating normally
    PROCESSOR_HEALTHY = 0;

    // Processor under load
    PROCESSOR_WARNING = 1;

    // Processor has errors
    PROCESSOR_ERROR = 2;
}

// FilterRequest to retrieve filters
message FilterRequest {
    // Hunter identifier
    string hunter_id = 1;
}

// FilterResponse contains filters for a hunter
message FilterResponse {
    // List of filters
    repeated Filter filters = 1;
}

// Filter definition
message Filter {
    // Unique filter identifier
    string id = 1;

    // Filter type
    FilterType type = 2;

    // Filter pattern/value
    string pattern = 3;

    // Target hunter IDs (empty = all hunters)
    repeated string target_hunters = 4;

    // Filter enabled
    bool enabled = 5;

    // Filter description
    string description = 6;
}

// FilterType enum
enum FilterType {
    // SIP user (From/To headers) - extracts user part for suffix/wildcard matching
    // Use for phone number suffix matching (e.g., *456789 matches +49123456789)
    FILTER_SIP_USER = 0;

    // Phone number (with wildcard support)
    FILTER_PHONE_NUMBER = 1;

    // IP address or CIDR range
    FILTER_IP_ADDRESS = 2;

    // Call-ID
    FILTER_CALL_ID = 3;

    // Codec
    FILTER_CODEC = 4;

    // Custom BPF filter
    FILTER_BPF = 5;

    // SIP URI (From/To headers) - extracts user@domain for exact/pattern matching
    // Use for matching full SIP identities (e.g., alice@example.com)
    FILTER_SIP_URI = 6;

    // DNS domain name (with glob-style wildcard support)
    // Examples: *.example.com, malware.com, *.bad-domain.*
    FILTER_DNS_DOMAIN = 7;

    // Email address (sender or recipient, with glob-style wildcard support)
    // Examples: *@example.com, admin@*, user@company.com
    FILTER_EMAIL_ADDRESS = 8;

    // Email subject line (with glob-style wildcard support)
    // Examples: *confidential*, invoice*, *password*
    FILTER_EMAIL_SUBJECT = 9;

    // TLS Server Name Indication (SNI) hostname
    // Examples: *.google.com, api.example.com
    FILTER_TLS_SNI = 10;

    // TLS JA3 client fingerprint hash (32-char hex MD5)
    // Example: e7d705a3286e19ea42f587b344ee6865
    FILTER_TLS_JA3 = 11;

    // TLS JA3S server fingerprint hash (32-char hex MD5)
    // Example: ae4edc6faf64d08308082ad26be60767
    FILTER_TLS_JA3S = 12;

    // TLS JA4 fingerprint (updated format)
    // Example: t13d1516h2_8daaf6152771_b186095e22bb
    FILTER_TLS_JA4 = 13;

    // HTTP Host header (with glob-style wildcard support)
    // Examples: *.example.com, api.*, admin.internal.corp
    FILTER_HTTP_HOST = 14;

    // HTTP URL path (with glob-style wildcard support)
    // Examples: /api/*, */admin/*, /login*
    FILTER_HTTP_URL = 15;

    // IMSI (International Mobile Subscriber Identity)
    // 15 digits from Authorization header or P-Asserted-Identity
    // Format in SIP: username@ims.mnc<MNC>.mcc<MCC>.3gppnetwork.org
    // Example: 234150999999999 (MCC=234, MNC=15, MSIN=0999999999)
    FILTER_IMSI = 16;

    // IMEI (International Mobile Equipment Identity)
    // 15 digits from Contact header +sip.instance parameter
    // Format in SIP: urn:gsma:imei:<TAC>-<SNR>-<CD>
    // Example: 353456789012345 (normalized, without dashes)
    FILTER_IMEI = 17;
}

// FilterUpdate pushed to hunters in real-time
message FilterUpdate {
    // Update type
    FilterUpdateType update_type = 1;

    // Filter being added/modified/deleted
    Filter filter = 2;
}

// FilterUpdateType enum
enum FilterUpdateType {
    // Filter added
    UPDATE_ADD = 0;

    // Filter modified
    UPDATE_MODIFY = 1;

    // Filter deleted
    UPDATE_DELETE = 2;
}

// FilterUpdateResult response after filter update
message FilterUpdateResult {
    // Success
    bool success = 1;

    // Error message if failed
    string error = 2;

    // Number of hunters that received the update
    uint32 hunters_updated = 3;
}

// FilterDeleteRequest to delete a filter
message FilterDeleteRequest {
    // Filter ID to delete
    string filter_id = 1;
}

// AuthTokenRequest to request an authorization token
message AuthTokenRequest {
    // Target processor ID to authorize operations for
    string target_processor_id = 1;
}

// AuthorizationToken for deep chain management operations
// When a top-level processor issues management commands to deep downstream processors,
// intermediate processors validate this token to authorize the operation.
message AuthorizationToken {
    // Cryptographic signature (RSA-SHA256) of the token
    // Signed by the root processor using its TLS private key
    bytes signature = 1;

    // Timestamp when token was issued (Unix nanoseconds)
    int64 issued_at_ns = 2;

    // Timestamp when token expires (Unix nanoseconds)
    int64 expires_at_ns = 3;

    // Target processor ID that this token authorizes operations for
    string target_processor_id = 4;

    // Processor ID of the root processor that issued this token (for auditing)
    string issuer_id = 5;

    // Chain of processor IDs from issuer to target (for auditing)
    repeated string processor_chain = 6;
}

// ProcessorFilterRequest to update filter on a specific processor
message ProcessorFilterRequest {
    // Target processor identifier
    string processor_id = 1;

    // Filter to add or modify
    Filter filter = 2;

    // Optional: Authorization token for deep chain operations
    // Required when target processor is not directly connected
    AuthorizationToken auth_token = 3;
}

// ProcessorFilterDeleteRequest to delete filter from a specific processor
message ProcessorFilterDeleteRequest {
    // Target processor identifier
    string processor_id = 1;

    // Filter ID to delete
    string filter_id = 2;

    // Optional: Authorization token for deep chain operations
    // Required when target processor is not directly connected
    AuthorizationToken auth_token = 3;
}

// ProcessorFilterQuery to retrieve filters from a specific processor
message ProcessorFilterQuery {
    // Target processor identifier
    string processor_id = 1;

    // Optional: filter by hunter ID on that processor
    string hunter_id = 2;

    // Optional: Authorization token for deep chain operations
    // Required when target processor is not directly connected
    AuthorizationToken auth_token = 3;
}

// StatusRequest to get hunter status (for TUI)
message StatusRequest {
    // Optional: filter by hunter ID
    string hunter_id = 1;
}

// StatusResponse with hunter statuses
message StatusResponse {
    // Connected hunters
    repeated ConnectedHunter hunters = 1;

    // Processor statistics
    ProcessorStats processor_stats = 2;
}

// ConnectedHunter status information
message ConnectedHunter {
    // Hunter identifier
    string hunter_id = 1;

    // Hostname
    string hostname = 2;

    // Remote address
    string remote_addr = 3;

    // Connection status
    HunterStatus status = 4;

    // Connected duration (seconds)
    uint64 connected_duration_sec = 5;

    // Last heartbeat timestamp
    int64 last_heartbeat_ns = 6;

    // Current statistics
    HunterStats stats = 7;

    // Active filters
    repeated Filter filters = 8;

    // Network interfaces being captured
    repeated string interfaces = 9;

    // Hunter capabilities (filter types, GPU acceleration, etc.)
    HunterCapabilities capabilities = 10;
}

// ProcessorStats for processor node
message ProcessorStats {
    // Total hunters connected
    uint32 total_hunters = 1;

    // Healthy hunters
    uint32 healthy_hunters = 2;

    // Warning hunters
    uint32 warning_hunters = 3;

    // Error hunters
    uint32 error_hunters = 4;

    // Total packets received from all hunters
    uint64 total_packets_received = 5;

    // Total packets forwarded upstream
    uint64 total_packets_forwarded = 6;

    // Total filters active
    uint32 total_filters = 7;

    // Processor identifier
    string processor_id = 8;

    // Processor status
    ProcessorStatus status = 9;

    // Upstream processor address (if forwarding to another processor)
    // Empty if this is a leaf processor (no upstream)
    string upstream_processor = 10;
}

// ListHuntersRequest to retrieve available hunters
message ListHuntersRequest {
    // No parameters needed - returns all available hunters
}

// ListHuntersResponse contains list of available hunters
message ListHuntersResponse {
    // Available hunters on this processor
    repeated AvailableHunter hunters = 1;
}

// AvailableHunter represents a hunter available for subscription
message AvailableHunter {
    // Hunter identifier
    string hunter_id = 1;

    // Hostname
    string hostname = 2;

    // Network interfaces being captured
    repeated string interfaces = 3;

    // Current status
    HunterStatus status = 4;

    // Remote address
    string remote_addr = 5;

    // Connected duration (seconds)
    uint64 connected_duration_sec = 6;

    // Hunter capabilities (filter types, GPU acceleration, etc.)
    HunterCapabilities capabilities = 7;
}

// TopologyRequest to retrieve topology
message TopologyRequest {
    // No parameters needed - returns full downstream topology
}

// TopologyResponse contains the complete topology
message TopologyResponse {
    // This processor's information
    ProcessorNode processor = 1;
}

// NodeType distinguishes between different processor types
enum NodeType {
    // Pure processor: receives packets from remote hunters (default)
    NODE_TYPE_PROCESSOR = 0;

    // Tap: captures packets locally from network interfaces
    NODE_TYPE_TAP = 1;
}

// ProcessorNode represents a processor in the topology tree
message ProcessorNode {
    // Processor address
    string address = 1;

    // Processor identifier
    string processor_id = 2;

    // Processor status
    ProcessorStatus status = 3;

    // Upstream processor address (empty if this is root)
    string upstream_processor = 4;

    // Hunters directly connected to this processor
    repeated ConnectedHunter hunters = 5;

    // Downstream processors forwarding to this processor
    repeated ProcessorNode downstream_processors = 6;

    // Hierarchy depth (0 = root/leaf with no upstream, 1 = direct child, etc.)
    uint32 hierarchy_depth = 7;

    // Whether this processor is reachable for management operations
    bool reachable = 8;

    // Reason why processor is unreachable (empty if reachable)
    string unreachable_reason = 9;

    // Node type: TAP captures locally, PROCESSOR receives from hunters
    NodeType node_type = 10;

    // Interfaces being captured (only populated for TAP nodes)
    repeated string capture_interfaces = 11;
}

// TopologySubscribeRequest to subscribe to topology updates
message TopologySubscribeRequest {
    // Include downstream processor topology changes (default: true)
    bool include_downstream = 1;

    // Client identifier for logging/tracking
    string client_id = 2;
}

// TopologyUpdate represents a real-time topology change event
message TopologyUpdate {
    // Update type
    TopologyUpdateType update_type = 1;

    // Timestamp when update occurred (Unix nanoseconds)
    int64 timestamp_ns = 2;

    // Processor where the event originated
    string processor_id = 3;

    // Event details (one of the following)
    oneof event {
        HunterConnectedEvent hunter_connected = 4;
        HunterDisconnectedEvent hunter_disconnected = 5;
        ProcessorConnectedEvent processor_connected = 6;
        ProcessorDisconnectedEvent processor_disconnected = 7;
        HunterStatusChangedEvent hunter_status_changed = 8;
    }
}

// TopologyUpdateType enum
enum TopologyUpdateType {
    // Hunter connected to a processor
    TOPOLOGY_HUNTER_CONNECTED = 0;

    // Hunter disconnected from a processor
    TOPOLOGY_HUNTER_DISCONNECTED = 1;

    // Downstream processor connected
    TOPOLOGY_PROCESSOR_CONNECTED = 2;

    // Downstream processor disconnected
    TOPOLOGY_PROCESSOR_DISCONNECTED = 3;

    // Hunter status changed (healthy -> warning, etc.)
    TOPOLOGY_HUNTER_STATUS_CHANGED = 4;
}

// HunterConnectedEvent when a hunter connects
message HunterConnectedEvent {
    // Hunter information
    ConnectedHunter hunter = 1;
}

// HunterDisconnectedEvent when a hunter disconnects
message HunterDisconnectedEvent {
    // Hunter ID that disconnected
    string hunter_id = 1;

    // Reason for disconnection
    string reason = 2;
}

// ProcessorConnectedEvent when a downstream processor connects
message ProcessorConnectedEvent {
    // Processor node information
    ProcessorNode processor = 1;
}

// ProcessorDisconnectedEvent when a downstream processor disconnects
message ProcessorDisconnectedEvent {
    // Processor ID that disconnected
    string processor_id = 1;

    // Processor address
    string address = 2;

    // Reason for disconnection
    string reason = 3;
}

// HunterStatusChangedEvent when a hunter's status changes
message HunterStatusChangedEvent {
    // Hunter ID
    string hunter_id = 1;

    // Previous status
    HunterStatus old_status = 2;

    // New status
    HunterStatus new_status = 3;
}
